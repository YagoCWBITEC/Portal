<!DOCTYPE html>
<html>
<head>
    <title>PDV</title>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>

<body class="dashboard-body">

<a href="/dashboard" class="btn-voltar">â¬… Voltar</a>

<div id="reportContainer" style="height:100vh;"></div>

<script>

fetch("/get_embed_config/pdv")
.then(res => res.json())
.then(data => {

    var models = window['powerbi-client'].models;

    // ðŸ” MONTA FILTRO APENAS PARA USUÃRIO LIMITADO
    let filters = [];

    if (data.role === "limitado") {
        filters = [{
            $schema: "http://powerbi.com/product/schema#basic",
            target: {
                table: "dPromotor",
                column: "Email"
            },
            operator: "In",
            values: [data.username]
        }];
    }

    var embedConfig = {
        type: 'report',
        id: data.reportId,
        embedUrl: data.embedUrl,
        accessToken: data.embedToken,
        tokenType: models.TokenType.Embed,

        // PÃ¡gina especÃ­fica vinda do backend
        pageName: data.pageName,

        // âœ… filtro aplicado globalmente
        filters: filters,

        // ConfiguraÃ§Ãµes visuais
        settings: {
            panes: {
                filters: { visible: false },
                pageNavigation: { visible: false }
            }
        }
    };

    var reportContainer = document.getElementById('reportContainer');

    powerbi.reset(reportContainer);

    var report = powerbi.embed(reportContainer, embedConfig);

})
.catch(error => {
    console.error("Erro ao carregar embed config:", error);
});

</script>

</body>
</html>