<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DESEMPENHO GERAL</title>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>

<body class="dashboard-body">

<a href="/dashboard" class="btn-voltar">‚¨Ö Voltar</a>

<div id="reportContainer" style="height:100vh; width: 100%;"></div>

<script>
// 1. Garantir que o Power BI Client est√° dispon√≠vel
window.onload = function() {
    
    const pbi = window['powerbi-client'];
    if (!pbi) {
        console.error("SDK do Power BI n√£o foi carregado!");
        return;
    }

    fetch("/get_embed_config/desempenho")
    .then(res => res.json())
    .then(data => {
        console.log("=== DIAGN√ìSTICO DE FILTRO ===");
        console.log("Role:", data.role);
        console.log("Filtro valor:", data.email);

        const models = pbi.models;
        let filters = [];

        // üîê APLICA√á√ÉO DO FILTRO PARA O CONRADO
        if (data.role === "limitado") {
            filters.push({
                $schema: "http://powerbi.com/product/schema#basic",
                target: {
                    table: "vSellOutBI", // Verifique se o nome no Power BI √© exatamente este
                    column: "Coordenador"
                },
                operator: "In",
                values: [data.email] // "CONRADO B COMERCIAL"
            });
            console.log("Filtro estruturado:", filters);
        }
const embedConfig = {
    type: 'report',
    id: data.reportId,
    embedUrl: data.embedUrl,
    accessToken: data.embedToken,
    tokenType: models.TokenType.Embed,
    pageName: data.pageName,
    filters: filters, // Mant√©m o filtro do Conrado que funcionou
    settings: {
        panes: {
            filters: { visible: false },
            pageNavigation: { visible: false }
        },
        // MANTENHA ASSIM: N√£o force transpar√™ncia se o BI j√° tiver fundo
        background: models.BackgroundType.Default 
    }
};
        const reportContainer = document.getElementById('reportContainer');
        
        // Reset e Embed
        powerbi.reset(reportContainer);
        const report = powerbi.embed(reportContainer, embedConfig);

        // Captura de erros espec√≠ficos do Power BI
        report.on("error", function (event) {
            console.error("ERRO DETALHADO DO POWER BI:", event.detail);
        });

    })
    .catch(error => {
        console.error("Erro na requisi√ß√£o fetch ou processamento:", error);
    });
};
</script>

</body>
</html>